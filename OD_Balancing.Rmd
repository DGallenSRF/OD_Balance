---
title: "R Notebook"
output:
  html_notebook:
    theme: united
    highlight: tango
---

```{r setup}

knitr::opts_knit$set(root.dir = "C:/Users/dgallen/Desktop/Projects/OD balance/OD")
getwd()
library(readxl)
```


```{r sample data}

# percent <- matrix(c(.058996,0,0,0,0,0,0,0,0,0,0,
#                     .015345,0,.021764,0,0,0,0,0,0,0,0,
#                     .023861,0,.0454,.205,0,0,0,0,0,0,0,
#                     .08912,.087,.227,.193309,.167668,.167668,0,0,0,0,0,
#                     .4905,.1886,.387468,.0557,.181897,.181897,0,0,0,0,0,
#                     .088092,.1146,.1046,.1245,.4956,.4957,.5769,0,0,0,0,
#                     .06139,.254,.14186,.1177,.075,.072,.1273,.301,.0835,.083501,.08457,
#                     .0147,0,0.0009,.037175,0,0,.063356,.063797,.2961,.2961,.306974,
#                     .15795,.355,.07006,.266419,.079,0.079,.232417,.635,.62,.6203,.608457), nrow = 11, ncol = 9)
# volume <- matrix(c(401,25,625,81,80,0,57,119,310,28,180), nrow = 11)
# target <- matrix(c(32,28,61,115,297,275,391,136,571), ncol = 9)

# percent <- matrix(c(.21,.43,0,
#                     .06,.08,.15,
#                     .73,.49,.85),nrow = 3,ncol = 3)
# volume <- matrix(c(587,47,112), nrow = 3)
# target <- matrix(c(422,45,279), ncol = 3)


# percent <- data.matrix(read.csv('matrix3.csv',
#                                 header = FALSE,
#                                 stringsAsFactors = FALSE))
# volume <- matrix(c(297,77,52,20,39,25,83), nrow = 7)
# target <- matrix(c(61,38,494), ncol = 3)

# volume <- matrix(c(329,84,64,15,54,11,105), nrow = 7)
# target <- matrix(c(87,40,535), ncol = 3)

# percent <- data.matrix(read.csv('matrix.csv',
#                                 header = FALSE,
#                                 stringsAsFactors = FALSE))
# volume <- matrix(c(592,172,225,48,92,78,149,3,131,5,64,39,342,64,57,77),nrow = 16)
# target <- matrix(c(66,172,52,94,121,102,58,59,187,255,70,132,770), ncol = 13)

# target <- matrix(c(86,196,37,76,115,86,78,71,270,290,101,140,1222),ncol = 13)
# volume <- matrix(c(662,196,245,62,164,95,190,38,159,27,84,44,499,103,56,144), nrow = 16)


# percent <- matrix(c(.2689,NA,NA,NA,NA,
#               .0936,.07516,NA,NA,NA,
#               .3237,.4681,.49745,.54248,NA,
#               .14873,.2851,.34164,.32259,.75610,
#               .16496,.1716,.1609,.13493,.2439), nrow = 5, ncol = 5)
# volume <- matrix(c(322,79,40,48,37),  nrow = 5)
# target <- matrix(c(112,31,21,215,147),ncol = 5)



# percent <- data.matrix(read.csv('matrix2.csv',
#                                 header = FALSE,
#                                 stringsAsFactors = FALSE))
# target <- matrix(c(401,86,81,129,133,56,59,239,151,840),ncol = 10)
# volume <- matrix(c(940,203,1,43,231,78,50,42,63,65,37,71,33,294,24), nrow = 15)
```


Check to ensure that the target and volume sets sum to the same value.

```{r Check datasets}

vol_1 <- InputVol[[11]]
tar_1 <- Targets[[11]]
percent_1 <- percent_list[[11]]

volume <- vol_1[[20]]$InputVol
target <- tar_1[[20]]$Target
percent  <- percent_1

sum(target) == sum(volume)

print(sum(target))
print(sum(volume))

print(target)
print(volume)
print(percent)
```

Also make sure that the rows of the percent matrix sum to 100 (as they should when orginially imported from streetlight).

```{r percent check}

rowSums(percent,na.rm = TRUE) 

```

The values are hard coded here with 4+ significant digits but it is close enough for this step.

#### Change Percentages to get cars within 5

Create a function that will iterate through each column and change +- 1% to get the difference between the target and volume to less than 5 cars.

```{r iterate percentage by 1%}

scramble <- function(volume,percent,target) {
  
  col_no <- ncol(percent)
  row_no <- nrow(percent)
  
  ## setup a matrix to hold the results
  j <- matrix(nrow = row_no, ncol = col_no)
  
  
  for(n in c(1:col_no)) {
    
    x <- percent[,n]
    
    cnt <- 1
    # itr <- 1
    
    ##repeat loop will stop on given if command - see below
    repeat {
      x[cnt] <- ifelse(sum(x*volume, na.rm = T)-target[n] < 0,
                       (ifelse(x[cnt] >= .99,
                               x[cnt],x[cnt] + .01)),
                        (ifelse(x[cnt] <= .01,
                               x[cnt],x[cnt] - .01)))
      
      cnt <- ifelse(cnt == row_no, 1, cnt + 1)
      # itr <- itr + 1
      
      ##if total cars are less than 5 "break" the loop
      if(abs(sum(x * volume, na.rm = T) - target[n]) < 2) {
        break
      }
    }
    j[,n] <- x
  }
  return(j)
}
```

Check results:

```{r scramble data}

sc <- scramble(volume = volume, percent = percent, target = target)
sc
colSums(apply(sc, 2, function(x) x * volume),na.rm = TRUE)-target
```

#### Fix percentage column

Iterate through the matrix to get the percentage sum for each row to be within 1% of 100%.

```{r percent fix}

percent_fix <- function(dat,target,volume){
  
  col_no <- ncol(dat)
  row_no <- nrow(dat)
  
  for(n in c(1:row_no)){
    
    y <- dat[n,]

    repeat {
      
      col_diff <- colSums(apply(dat,2,function(x) x*volume), na.rm = TRUE)-target
      row_sum <- sum(y, na.rm = TRUE)
      
      index1 <- 1
      
      repeat {
        
        min_col <- match(sort(col_diff)[index1],col_diff)
        index1 <- index1 + 1
        
        log1 <- !is.na(y[min_col]) & y[min_col] >= 0 & y[min_col] <= 0.99
        log2 <- !is.na(y[min_col]) & y[min_col] == 1
        
        if(log1 | log2 ){
          break
        }
      }
      
      index2 <- 1
      repeat {
        
        max_col <- match(sort(col_diff,decreasing = TRUE)[index2],col_diff)
        index2 <- index2 + 1
        
        log1 <- !is.na(y[max_col]) & y[max_col] >= 0.01 & y[max_col] <= 1
        log2 <- !is.na(y[max_col]) & y[max_col] == 1
        
        if(log1 | log2 ){
          break
        }
      }
      
      x <- ifelse(row_sum < 1, 
                  min_col, 
                  max_col)
      
      y[x] <- ifelse(sum(y, na.rm = TRUE) >= 0.99 & sum(y, na.rm = TRUE) <= 1.01,
                     
                     y[x],
                     
                     ifelse(sum(y, na.rm = TRUE) < 1, 
                            y[x] + .001,
                            y[x] - .001))
      dat[n,] <- y
      
      if(sum(y,na.rm = TRUE) >= 0.99 & sum(y,na.rm = TRUE) <= 1.01) {
        break
      }
    }
  }
return(dat)
}

```

```{r run percent fix}
perc <- percent_fix(dat = sc, target = target,volume = volume)
perc
rowSums(perc, na.rm = TRUE)
```

This will have thrown off our column sums which no longer will be with 5 cars of the target.

```{r column sum checks}
colSums(apply(perc, 2, function(x) x * volume), na.rm = TRUE)-target
```


#### Distribute remainders

Create a function to distrubute the remainding balance across the table. 


```{r proportion percentages}

porportion <- function(percent,volume) {
  # 
  # percent <- perc
  # volume <- volume
  
  dat_new <- apply(percent,2,function(x) x * volume)
  
  # round(apply(dat,2,function(x) x * volume),0)
  
  sum_col <- colSums(dat_new, na.rm = TRUE)
  
  porportion <- mapply(function(x) {dat_new[,x]/sum_col[x]},
                       x = c(1:ncol(dat_new)))
  
  col_diff <- sum_col-target
  
  prop_diff <- mapply(function(x) {porportion[,x]*col_diff[x]},
                      x = c(1:ncol(porportion)))
  
  diff <- mapply(function(x) {ifelse(is.na(prop_diff[,x]/volume),prop_diff[,x],prop_diff[,x]/volume)},
                 x = c(1:ncol(prop_diff)))
  
  k <- percent - diff

  for(n in c(1:nrow(k))){

    col_num <- ncol(k)

    repeat{

      vector <- k
      vector[n,col_num] <- vector[n,col_num] - (sum(vector[n,], na.rm = TRUE)-1)

      col_num <- col_num - 1

      if(vector[n,col_num+1]>=0){
        break
      }
    }
    k[n,col_num+1] <- vector[n,col_num+1]
  }

  dat_final <- k
  # dat_final[,22] <- dat_final[,22] - (rowSums(k, na.rm = FALSE) -1)
  return(dat_final)
}



```

Check the final data set.

```{r check final}
final_data <- porportion(percent = perc, volume = volume)

final_data
rowSums(final_data, na.rm = TRUE)
round(colSums(apply(final_data,2,function(x) x*volume),na.rm = TRUE)-target,3)
```


```{r combine table 11}

```



