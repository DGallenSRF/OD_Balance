---
title: "R Notebook"
output:
  html_notebook:
    theme: united
    highlight: tango
---

```{r setup}

knitr::opts_knit$set(root.dir = "C:/Users/dgallen/Desktop/Projects/OD balance/OD")
getwd()
library(readxl)
```

```{r load data}
rm(list = ls())

read_excel_sheets <- function(file){
  
  sheets <- readxl::excel_sheets("TablePercents_split.xlsx")
  x <- lapply(sheets, function(x) readxl::read_xlsx("TablePercents_split.xlsx", sheet = x,col_names = FALSE, na = 'NA'))
  x <- lapply(x, as.matrix)
  names(x) <- sheets
  x
}

percent_list <- read_excel_sheets("TablePercents_split.xlsx")

InputVolume <- read.csv('InputVols.csv')

InputVol <- list()

for(n in 1:length(levels(as.factor(InputVolume$Table)))) {

  g <- InputVolume[InputVolume$Table==n,]

  tab <- split(g,paste("TP",g$TimePeriod,sep=''))

  InputVol[[n]] <- tab
}


Target <- read.csv('TargetVols.csv')

Targets <- list()

for(n in 1:length(levels(as.factor(Target$Table)))) {

  g <- Target[Target$Table==n,]

  tab <- split(g,paste("TP",g$TimePeriod,sep=''))

  Targets[[n]] <- tab
}
```

```{r}

vol_3 <- InputVol[[3]]
tar_3 <- Targets[[3]]
percent_3 <- percent_list[[3]]

OD_Bal <- function(volume_list,percent,target_list){
  
  table_list <- list()
  
  for(i in c(1:length(volume_list))){
    
    volume <- vol_3[[i]]$InputVol
    target <- tar_3[[i]]$Value
    
    # col_fix <- function(volume,percent,target) {
    
    col_no <- ncol(percent)
    row_no <- nrow(percent)
    
    ## setup a matrix to hold the results
    dat <- matrix(nrow = row_no, ncol = col_no)
    
    
    for(n in c(1:col_no)) {
      
      x <- percent[,n]
      
      cnt <- 1
      # itr <- 1
      
      ##repeat loop will stop on given if command - see below
      repeat {
        x[cnt] <- ifelse(sum(x*volume, na.rm = T)-target[n] < 0,
                         (ifelse(x[cnt] >= .99,
                                 x[cnt],x[cnt] + .01)),
                         (ifelse(x[cnt] <= .01,
                                 x[cnt],x[cnt] - .01)))
        
        cnt <- ifelse(cnt == row_no, 1, cnt + 1)
        # itr <- itr + 1
        
        ##if total cars are less than 5 "break" the loop
        if(abs(sum(x * volume, na.rm = T) - target[n]) < 5) {
          break
        }
      }
      dat[,n] <- x
    }
    
    dat_2 <- dat
    
    for(n in c(1:row_no)){
    
    y <- dat_2[n,]

    repeat {
      
      col_diff <- colSums(apply(dat_2,2,function(x) x*volume), na.rm = TRUE)-target
      row_sum <- sum(y, na.rm = TRUE)
      
      index1 <- 1
      
      repeat {
        
        min_col <- match(sort(col_diff)[index1],col_diff)
        index1 <- index1 + 1
        
      log1 <- !is.na(y[min_col]) & y[min_col] >= 0.01 & y[min_col] <= 0.99
      log2 <- !is.na(y[min_col]) & y[min_col] == 1
      
      if(log1 | log2 ){
          break
        }
      }
      
      index2 <- 1
      
      repeat {
        
        max_col <- match(sort(col_diff,decreasing = TRUE)[index2],col_diff)
        index2 <- index2 + 1
        
        log1 <- !is.na(y[max_col]) & y[max_col] >= 0.01 & y[max_col] <= 0.99
        log2 <- !is.na(y[max_col]) & y[max_col] == 1
        
        if(log1 | log2 ){
          break
        }
      }
      
      x <- ifelse(row_sum < 1, 
                  min_col, 
                  max_col)
      
      y[x] <- ifelse(sum(y, na.rm = TRUE) >= 0.99 & sum(y, na.rm = TRUE) <= 1.01,
                     
                     y[x],
                     
                     ifelse(sum(y, na.rm = TRUE) < 1, 
                            y[x] + .001,
                            y[x] - .001))
      
      dat_2[n,] <- y
      
      if(sum(y,na.rm = TRUE) >= 0.99 & sum(y,na.rm = TRUE) <= 1.01) {
        break
        }
      }
    }
    
    # row_fix <- percent_fix(col_fix = col_fix, target = target,volume = volume)
    # 
    # porportion <- function(percent,volume) {
    
    vol_new <- apply(dat_2,2,function(x) x * volume)
    
    # round(apply(dat,2,function(x) x * volume),0)
    
    sum_col <- colSums(vol_new, na.rm = TRUE)
    
    porportion <- mapply(function(x) {vol_new[,x]/sum_col[x]},
                         x = c(1:ncol(vol_new)))
    
    col_diff <- sum_col-target
    
    prop_diff <- mapply(function(x) {porportion[,x]*col_diff[x]},
                        x = c(1:ncol(porportion)))
    
    diff <- mapply(function(x) {ifelse(is.na(prop_diff[,x]/volume),prop_diff[,x],prop_diff[,x]/volume)},
                   x = c(1:ncol(prop_diff)))
    
    k <- dat_2 - diff
    
    dat_final <- k
  dat_final[,ncol(dat_final)] <- k[,ncol(k)] - (rowSums(k, na.rm = TRUE)-1)
  
  table_list[[i]] <- dat_final 
  
  }
  return(table_list)
}

```

```{r}
final_data <- dat_final
final_data
rowSums(final_data, na.rm = TRUE)
colSums(apply(final_data,2,function(x) x*volume),na.rm = TRUE)-target
round(dat_final-percent,3)
```

