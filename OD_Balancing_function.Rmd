---
title: "R Notebook"
output:
  html_notebook:
    theme: united
    highlight: tango
---

```{r setup}

knitr::opts_knit$set(root.dir = "C:/Users/dgallen/Desktop/Projects/OD balance/OD")
getwd()
library(readxl)
```

```{r load data}
dir()
read_excel_sheets <- function(file){
  
  sheets <- readxl::excel_sheets(file)
  x <- lapply(sheets, function(x) readxl::read_xlsx(file, sheet = x,col_names = FALSE))
  x <- lapply(x, as.matrix)
  names(x) <- sheets
  x
}

list <- read_excel_sheets("TablePercents_split.xlsx")

InputVolume <- read.csv('InputVols.csv')

InputVol <- list()

for(n in 1:length(levels(as.factor(InputVolume$Table)))) {

  g <- InputVolume[InputVolume$Table==n,]

  tab <- split(g,paste("TP",g$TimePeriod,sep=''))

  InputVol[[n]] <- tab
}


Target <- read.csv('TargetVols.csv')

Targets <- list()

for(n in 1:length(levels(as.factor(Target$Table)))) {

  g <- Target[Target$Table==n,]

  tab <- split(g,paste("TP",g$TimePeriod,sep=''))

  Targets[[n]] <- tab
}
```

```{r}

sum(target) == sum(volume)

OD_Bal <- function(volume,percent,target){

col_fix <- function(volume,percent,target) {
  
  col_no <- ncol(percent)
  row_no <- nrow(percent)
  
  ## setup a matrix to hold the results
  j <- matrix(nrow = row_no, ncol = col_no)
  
  
  for(n in c(1:col_no)) {
    
    x <- percent[,n]
    
    cnt <- 1
    # itr <- 1
    
    ##repeat loop will stop on given if command - see below
    repeat {
      x[cnt] <- ifelse(x[cnt] <= .01,
                       x[cnt],
                       ifelse(x[cnt] >= .99,
                              x[cnt],
                              ifelse(sum(x*volume, na.rm = T)-target[n] < 0,
                                     x[cnt] + .01,
                                     x[cnt] - .01)))
      
      cnt <- ifelse(cnt == row_no, 1, cnt + 1)
      # itr <- itr + 1
      
      ##if total cars are less than 5 "break" the loop
      if(abs(sum(x * volume, na.rm = T) - target[n]) < 5) {
        break
      }
    }
    j[,n] <- x
  }
  return(j)
}

sc <- scramble(volume = volume, percent = percent, target = target)

percent_fix <- function(dat,target,volume){
  
  col_no <- ncol(dat)
  row_no <- nrow(dat)
  j <- matrix(nrow = row_no, ncol = col_no)
  
  for(n in c(1:row_no)){
    
    y <- dat[n,]

    repeat {
      
      col_diff <- colSums(apply(dat,2,function(x) x*volume))-target
      row_sum <- sum(y)
      
      index1 <- 1
      
      repeat {
        
        min_col <- match(sort(col_diff)[index1],col_diff)
        index1 <- index1 + 1
        
        if(y[min_col] >= 0.01 & y[min_col] <= 0.99 | any(y == 1)){
          break
        }
      }

      index2 <- 1
      repeat {
        
        max_col <- match(sort(col_diff,decreasing = TRUE)[index2],col_diff)
        index2 <- index2 + 1
        
        if(y[max_col] >= 0.01 & y[max_col] <= 0.99 | any(y == 1)){
          break
        }
      }
      
      min_col_index <- min_col
      max_col_index <- max_col
      x <- ifelse(row_sum < 1, 
                  min_col_index, 
                  max_col_index)
      
      y[x] <- ifelse(any(y == 1),y[x],
                     ifelse(sum(y) < 1, y[x] + .01, y[x] - .01))
      
      dat[n,] <- y
      
      if(sum(y) >= 0.99 & sum(y) <= 1.01) {
        break
      }
    }
  }
return(dat)
}

row_fix <- percent_fix(col_fix = col_fix, target = target,volume = volume)

porportion <- function(percent,volume) {
  
  dat_new <- apply(percent,2,function(x) x * volume)
  
  # round(apply(dat,2,function(x) x * volume),0)
  
  
  sum_col <- colSums(dat_new)
  
  porportion <- mapply(function(x) {dat_new[,x]/sum_col[x]},
                       x = c(1:ncol(dat_new)))
  
  col_diff <- sum_col-target
  
  prop_diff <- mapply(function(x) {porportion[,x]*col_diff[x]},
                      x = c(1:ncol(porportion)))
  
  diff <- mapply(function(x) {ifelse(is.na(prop_diff[,x]/volume),prop_diff[,x],prop_diff[,x]/volume)},
                 x = c(1:ncol(prop_diff)))
  
  k <- percent - diff
  
  dat_final <- k
  dat_final[,ncol(dat_final)] <- k[,ncol(k)] - (rowSums(k)-1)
  
  return(dat_final)
}

final_data <- porportion(percent = row_fix, volume = volume)



}
```
